<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="app-header">
        <h1>Quiz App</h1>
        <div id="auth-section" class="auth-section">
            <span id="username-display" style="display: none;"></span>
            <button id="login-btn" class="auth-btn">Login</button>
            <button id="logout-btn" class="auth-btn" style="display: none;">Logout</button>
        </div>
    </header>
    
    <!-- Login/Register Modal -->
    <div id="auth-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title">Login</h2>
            <form id="auth-form">
                <div id="email-field" style="display: none;">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email">
                </div>
                <div>
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div>
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" id="submit-btn">Login</button>
                <button type="button" id="toggle-register">Don't have an account? Register</button>
            </form>
            <div id="auth-error" style="color: red; display: none;"></div>
        </div>
    </div>

<main class="container app-container">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash">
                {{ messages[0] }}
            </div>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</main>


    <script>
      // Always use Gateway on port 8080, or detect if already on Gateway
      const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
      const GATEWAY_URL = currentPort === '8080' 
        ? window.location.origin 
        : 'http://localhost:8080';
      
      // Warn if accessing through Flask directly
      if (currentPort === '5000' || currentPort === '5001') {
        console.warn('⚠️ You are accessing the app directly through Flask. Please access through the Gateway at http://localhost:8080');
        console.warn('⚠️ Authentication will not work unless accessed through the Gateway.');
      }
      
      let authToken = localStorage.getItem('authToken');
      let isRegister = false;
      
      // Intercept all fetch requests to add Authorization header
      // This ensures JWT token is sent with every request to the Gateway
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const [url, options = {}] = args;
        
        // Only add Authorization header for requests to Gateway
        if (typeof url === 'string' && (url.startsWith(GATEWAY_URL) || url.startsWith('/'))) {
          const token = localStorage.getItem('authToken');
          if (token) {
            // Add Authorization header if not already present
            if (!options.headers) {
              options.headers = {};
            }
            if (!options.headers['Authorization'] && !options.headers['authorization']) {
              options.headers['Authorization'] = `Bearer ${token}`;
            }
            // Ensure credentials are included for cookies
            if (options.credentials === undefined) {
              options.credentials = 'include';
            }
          }
        }
        
        return originalFetch.apply(this, args);
      };

      // Success message function
      function showSuccessMessage(message) {
        // Create success notification element
        const notification = document.createElement('div');
        notification.className = 'success-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Trigger animation
        setTimeout(() => {
          notification.classList.add('show');
        }, 10);
        
        // Remove after animation
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // Auth UI Management
      function updateAuthUI() {
        const token = localStorage.getItem('authToken');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const usernameDisplay = document.getElementById('username-display');
        
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            usernameDisplay.textContent = `Hello, ${payload.username}`;
            usernameDisplay.style.display = 'inline';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline';
            authToken = token;
          } catch (e) {
            console.error('Invalid token', e);
            localStorage.removeItem('authToken');
            authToken = null;
          }
        } else {
          loginBtn.style.display = 'inline';
          logoutBtn.style.display = 'none';
          usernameDisplay.style.display = 'none';
        }
      }

      // Modal Management
      const modal = document.getElementById('auth-modal');
      const closeBtn = document.querySelector('.close');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const toggleRegister = document.getElementById('toggle-register');
      const authForm = document.getElementById('auth-form');
      const modalTitle = document.getElementById('modal-title');
      const submitBtn = document.getElementById('submit-btn');
      const emailField = document.getElementById('email-field');
      const authError = document.getElementById('auth-error');

      loginBtn.addEventListener('click', () => {
        isRegister = false;
        const emailInput = document.getElementById('email');
        modalTitle.textContent = 'Login';
        submitBtn.textContent = 'Login';
        emailField.style.display = 'none';
        emailInput.removeAttribute('required');
        authForm.reset();
        authError.style.display = 'none';
        modal.style.display = 'block';
      });

      logoutBtn.addEventListener('click', async () => {
        // Clear JWT token
        localStorage.removeItem('authToken');
        document.cookie = 'authToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        authToken = null;
        
        // Clear Flask session to reset anonymous session ID
        try {
          await fetch(`${GATEWAY_URL}/clear-session`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (e) {
          console.log('Session clear request failed (non-critical):', e);
        }
        
        updateAuthUI();
        showSuccessMessage('Successfully logged out!');
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      });

      toggleRegister.addEventListener('click', () => {
        isRegister = !isRegister;
        const emailInput = document.getElementById('email');
        if (isRegister) {
          modalTitle.textContent = 'Register';
          submitBtn.textContent = 'Register';
          emailField.style.display = 'block';
          emailInput.setAttribute('required', 'required');
          toggleRegister.textContent = 'Already have an account? Login';
        } else {
          modalTitle.textContent = 'Login';
          submitBtn.textContent = 'Login';
          emailField.style.display = 'none';
          emailInput.removeAttribute('required');
          toggleRegister.textContent = "Don't have an account? Register";
        }
        authError.style.display = 'none';
      });

      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      window.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Handle Auth Form Submission
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        authError.style.display = 'none';
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          authError.textContent = 'Please fill in all required fields.';
          authError.style.display = 'block';
          return;
        }
        
        if (isRegister) {
          const email = document.getElementById('email').value;
          if (!email) {
            authError.textContent = 'Please fill in all required fields.';
            authError.style.display = 'block';
            return;
          }
        }
        
        try {
          let response;
          let endpoint;
          let body;
          
          if (isRegister) {
            const email = document.getElementById('email').value;
            endpoint = `${GATEWAY_URL}/auth/register`;
            body = JSON.stringify({ username, email, password });
          } else {
            endpoint = `${GATEWAY_URL}/auth/login`;
            body = JSON.stringify({ username, password });
          }
          
          response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: body
          });
          
          // Try to parse JSON response
          let data;
          try {
            const text = await response.text();
            if (!text) {
              throw new Error('Empty response');
            }
            data = JSON.parse(text);
          } catch (parseError) {
            // If response is not JSON, handle it
            if (!response.ok) {
              if (response.status === 404) {
                authError.innerHTML = `Error 404: Cannot find authentication endpoint.<br><br>` +
                  `⚠️ <strong>Make sure you are accessing through the Gateway at http://localhost:8080</strong><br>` +
                  `The Gateway must be running (port 8080) for authentication to work.<br>` +
                  `Current URL: ${window.location.href}`;
              } else {
                authError.textContent = `Error: ${response.status} ${response.statusText}. Make sure the Gateway is running on port 8080.`;
              }
              authError.style.display = 'block';
              return;
            }
            throw new Error('Invalid response format');
          }
          
          // Handle registration (async saga pattern)
          if (isRegister) {
            // Only HTTP 201 Created means registration completed successfully
            if (response.status === 201 && data.token) {
              // Registration completed immediately - auto-login
              localStorage.setItem('authToken', data.token);
              authToken = data.token;
              document.cookie = `authToken=${data.token}; path=/; max-age=${24 * 60 * 60}`;
              
              // Clear anonymous session
              try {
                await fetch(`${GATEWAY_URL}/clear-session`, {
                  method: 'POST',
                  credentials: 'include'
                });
              } catch (e) {
                console.log('Session clear request failed (non-critical):', e);
              }
              
              updateAuthUI();
              modal.style.display = 'none';
              showSuccessMessage('Successfully registered and logged in!');
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } 
            // HTTP 200 or 202 means registration is pending (async)
            else if (response.status === 200 || response.status === 202) {
              // Show "Creating account..." UI
              const submitBtn = document.getElementById('submit-btn');
              const originalBtnText = submitBtn.textContent;
              submitBtn.disabled = true;
              submitBtn.textContent = 'Creating account...';
              authError.style.display = 'none';
              
              // Get task_id for status polling
              const task_id = data.task_id || (data.status_url ? data.status_url.split('/').pop() : null);
              
              if (!task_id) {
                authError.textContent = 'Registration started but could not get status ID. Please try logging in manually in a few moments.';
                authError.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
              }
              
              // Poll status endpoint until registration completes
              const maxPollAttempts = 60; // 60 attempts = 60 seconds max
              const pollInterval = 1000; // 1 second
              let pollAttempts = 0;
              let registrationCompleted = false;
              
              while (pollAttempts < maxPollAttempts && !registrationCompleted) {
                await new Promise(resolve => setTimeout(resolve, pollInterval));
                pollAttempts++;
                
                try {
                  const statusResponse = await fetch(`${GATEWAY_URL}/auth/register/status/${task_id}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                  });
                  
                  if (!statusResponse.ok) {
                    continue; // Keep polling on errors
                  }
                  
                  const statusData = await statusResponse.json();
                  
                  if (statusData.status === 'completed' && statusData.token) {
                    // Registration completed - auto-login
                    registrationCompleted = true;
                    localStorage.setItem('authToken', statusData.token);
                    authToken = statusData.token;
                    document.cookie = `authToken=${statusData.token}; path=/; max-age=${24 * 60 * 60}`;
                    
                    // Clear anonymous session
                    try {
                      await fetch(`${GATEWAY_URL}/clear-session`, {
                        method: 'POST',
                        credentials: 'include'
                      });
                    } catch (e) {
                      console.log('Session clear request failed (non-critical):', e);
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    updateAuthUI();
                    modal.style.display = 'none';
                    showSuccessMessage('Successfully registered and logged in!');
                    setTimeout(() => {
                      window.location.reload();
                    }, 1500);
                  } else if (statusData.status === 'failed') {
                    // Registration failed
                    registrationCompleted = true;
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    authError.textContent = statusData.error || 'Registration failed. Please try again.';
                    authError.style.display = 'block';
                  }
                  // If status is 'pending', continue polling
                } catch (pollError) {
                  console.error('Error polling registration status:', pollError);
                  // Continue polling on errors
                }
              }
              
              // If we exhausted polling attempts
              if (!registrationCompleted) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                authError.textContent = 'Registration is taking longer than expected. Please try logging in manually in a few moments.';
                authError.style.display = 'block';
              }
            } 
            // Error response
            else {
              let errorMsg = 'Registration failed';
              if (data && data.error) {
                errorMsg = data.error;
                if (errorMsg.includes('already exists')) {
                  errorMsg = 'This username or email is already registered. Please try logging in instead.';
                }
              } else if (response.status === 400) {
                errorMsg = data.error || 'Please fill in all required fields correctly.';
              } else {
                errorMsg = `Registration failed (${response.status}). Please try again.`;
              }
              authError.textContent = errorMsg;
              authError.style.display = 'block';
            }
          }
          // Handle login (synchronous)
          else {
            if (response.ok && data.token) {
              localStorage.setItem('authToken', data.token);
              authToken = data.token;
              document.cookie = `authToken=${data.token}; path=/; max-age=${24 * 60 * 60}`;
              
              // Clear anonymous session when logging in
              try {
                await fetch(`${GATEWAY_URL}/clear-session`, {
                  method: 'POST',
                  credentials: 'include'
                });
              } catch (e) {
                console.log('Session clear request failed (non-critical):', e);
              }
              
              updateAuthUI();
              modal.style.display = 'none';
              showSuccessMessage('Successfully logged in!');
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              // Handle login error response
              let errorMsg = 'Authentication failed';
              if (data && data.error) {
                errorMsg = data.error;
                if (errorMsg === 'Invalid credentials') {
                  errorMsg = 'Invalid username or password. Please check your credentials and try again.';
                }
              } else if (response.status === 401) {
                errorMsg = 'Invalid username or password. Please check your credentials and try again.';
              } else if (response.status === 400) {
                errorMsg = data.error || 'Please fill in all required fields correctly.';
              } else {
                errorMsg = `Authentication failed (${response.status}). Please try again.`;
              }
              authError.textContent = errorMsg;
              authError.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Auth error:', error);
          // Check if it's a network error (gateway not running)
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
            authError.innerHTML = `Network error: Cannot connect to Gateway.<br><br>` +
              `⚠️ <strong>Please ensure:</strong><br>` +
              `1. The Gateway is running on port 8080<br>` +
              `2. You are accessing the app at http://localhost:8080 (not port 5000)<br>` +
              `3. Check the Gateway console for errors`;
          } else {
            authError.textContent = `An unexpected error occurred: ${error.message}. Please try again.`;
          }
          authError.style.display = 'block';
        }
      });

      // Initialize auth UI on page load
      document.addEventListener('DOMContentLoaded', () => {
        updateAuthUI();
      });

      // Original answer selection script
      document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll(".answers").forEach(group => {
              group.addEventListener("click", e => {
                  if (!e.target.classList.contains("answer-btn")) return;

                  // remove selection from siblings
                  group.querySelectorAll(".answer-btn").forEach(btn =>
                      btn.classList.remove("selected")
                  );

                  // add selection to clicked one
                  e.target.classList.add("selected");
              });
          });
      });
    </script>

</body>
</html>
